<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nashville Events Calendar - Legistar Widget</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: #f8fafc;
  color: #1a202c;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Main Widget Container */
#calendar-widget-container {
  max-width: 90rem;
  margin: 2rem auto;
  background: white;
  border-radius: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 20px 40px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  position: relative;
}

/* Gradient top bar */
.gradient-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  opacity: 0.8;
  z-index: 1;
}

/* Calendar Section */
#calendar-widget {
  padding: 2rem;
}

/* Header */
.calendar-header {
  margin-bottom: 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.calendar-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.header-title h1 {
  font-size: 2rem;
  font-weight: 700;
  color: #2d3748;
  letter-spacing: -0.025em;
}

.header-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5a67d8;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
  background: #f7fafc;
  color: #4a5568;
  border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
  background: #edf2f7;
  border-color: #cbd5e0;
}

/* Navigation Controls */
.nav-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.calendar-nav {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.nav-btn {
  width: 36px;
  height: 36px;
  border: 1px solid #e2e8f0;
  background: white;
  border-radius: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  color: #4a5568;
}

.nav-btn:hover {
  background: #f7fafc;
  border-color: #cbd5e0;
  color: #2d3748;
}

.current-period {
  font-size: 1.125rem;
  font-weight: 600;
  color: #2d3748;
  min-width: 180px;
  text-align: center;
}

.view-toggle {
  display: flex;
  background: #f7fafc;
  border-radius: 0.5rem;
  padding: 0.25rem;
  gap: 0.25rem;
}

.view-btn {
  padding: 0.5rem 1rem;
  background: none;
  border: none;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: #718096;
  cursor: pointer;
  transition: all 0.2s;
}

.view-btn:hover {
  color: #4a5568;
}

.view-btn.active {
  background: white;
  color: #667eea;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Filters Section */
.filters-section {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 0.75rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.filters-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.filters-title {
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #718096;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  background: #667eea;
  color: white;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 600;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.375rem;
}

.filter-label {
  font-size: 0.8125rem;
  font-weight: 500;
  color: #4a5568;
}

.filter-select {
  padding: 0.5rem 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  background: white;
  color: #2d3748;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-select:hover {
  border-color: #cbd5e0;
}

.filter-select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Calendar Views */
.calendar-view {
  display: none;
  animation: fadeIn 0.3s ease-out;
}

.calendar-view.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Month View */
.month-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  background: #e2e8f0;
  border: 1px solid #e2e8f0;
  border-radius: 0.75rem;
  overflow: hidden;
}

.weekday-header {
  background: #f8fafc;
  padding: 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #718096;
  text-align: center;
}

.calendar-day {
  background: white;
  min-height: 120px;
  height: 120px;
  padding: 0.5rem;
  position: relative;
  cursor: pointer;
  transition: all 0.2s;
  overflow: hidden;
}

.calendar-day:hover {
  background: #f7fafc;
}

.calendar-day.other-month {
  background: #fafbfc;
  color: #cbd5e0;
}

.calendar-day.today {
  background: #f0f4ff;
}

.calendar-day.selected {
  background: #e9efff;
  box-shadow: inset 0 0 0 2px #667eea;
}

.day-number {
  font-size: 0.875rem;
  font-weight: 500;
  color: #4a5568;
  margin-bottom: 0.25rem;
}

.day-events {
  display: flex;
  flex-direction: column;
  gap: 0.125rem;
}

.event-dot {
  width: 100%;
  height: 20px;
  background: #667eea;
  border-radius: 0.25rem;
  font-size: 0.6875rem;
  color: white;
  padding: 0.125rem 0.375rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s;
}

.event-dot:hover {
  transform: translateX(2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.event-dot.body-council {
  background: #667eea;
}

.event-dot.body-committee {
  background: #9f7aea;
}

.event-dot.body-board {
  background: #ed8936;
}

.more-events {
  font-size: 0.6875rem;
  color: #718096;
  margin-top: 0.125rem;
  font-weight: 500;
}

/* Week View */
.week-grid {
  display: grid;
  grid-template-columns: 80px repeat(7, 1fr);
  gap: 1px;
  background: #e2e8f0;
  border: 1px solid #e2e8f0;
  border-radius: 0.75rem;
  overflow: hidden;
}

.time-slot {
  background: #f8fafc;
  padding: 0.5rem;
  font-size: 0.75rem;
  color: #718096;
  text-align: right;
  border-right: 1px solid #e2e8f0;
}

.week-day-column {
  background: white;
  position: relative;
  min-height: 60px;
}

.week-event {
  position: absolute;
  left: 4px;
  right: 4px;
  background: #667eea;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  cursor: pointer;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  transition: all 0.2s;
}

.week-event:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  z-index: 10;
}

/* List View */
.events-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.event-card {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 0.75rem;
  padding: 1.5rem;
  transition: all 0.2s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.event-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
  transform: translateX(-100%);
  transition: transform 0.3s;
}

.event-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border-color: #cbd5e0;
}

.event-card:hover::before {
  transform: translateX(0);
}

.event-header {
  display: flex;
  align-items: start;
  justify-content: space-between;
  gap: 1rem;
  margin-bottom: 0.75rem;
}

.event-time {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: #2d3748;
}

.event-time svg {
  width: 16px;
  height: 16px;
  color: #667eea;
}

.event-body-badge {
  padding: 0.25rem 0.75rem;
  background: #f0f4ff;
  color: #667eea;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
}

.event-details {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.event-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #2d3748;
}

.event-location {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  font-size: 0.875rem;
  color: #718096;
}

.event-location svg {
  width: 14px;
  height: 14px;
}

.event-items-count {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  margin-top: 0.5rem;
  padding: 0.375rem 0.75rem;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 0.5rem;
  font-size: 0.8125rem;
  color: #4a5568;
}

.legislation-count {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  margin-left: 0.5rem;
  padding: 0.375rem 0.75rem;
  background: #f0f4ff;
  border: 1px solid #e0e7ff;
  border-radius: 0.5rem;
  font-size: 0.8125rem;
  color: #667eea;
  font-weight: 500;
}

/* Event Details Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  animation: fadeIn 0.2s ease-out;
}

.modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.modal-content {
  background: white;
  border-radius: 1rem;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(to bottom, #fafbfc, white);
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #2d3748;
}

.close-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.5rem;
  color: #718096;
  transition: all 0.2s;
}

.close-btn:hover {
  background: #f7fafc;
  color: #4a5568;
}

.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  max-height: calc(90vh - 140px);
}

.event-detail-section {
  margin-bottom: 1.5rem;
}

.detail-label {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #718096;
  margin-bottom: 0.5rem;
}

.detail-value {
  font-size: 0.9375rem;
  color: #2d3748;
}

.agenda-items-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.agenda-item {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 0.5rem;
  padding: 1rem;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.agenda-item.has-matter {
  cursor: pointer;
  border-left: 3px solid #667eea;
  padding-left: calc(1rem - 3px);
}

.agenda-item.has-matter:hover {
  background: #f0f4ff;
  border-color: #5a67d8;
  transform: translateX(4px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.agenda-item-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.25rem;
}

.agenda-item-number {
  font-size: 0.875rem;
  font-weight: 600;
  color: #667eea;
}

.matter-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.75rem;
  color: #667eea;
  font-weight: 500;
}

.agenda-item-title {
  font-size: 0.875rem;
  color: #4a5568;
}

.matter-info {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
  font-size: 0.75rem;
}

.matter-file {
  color: #718096;
}

.matter-type {
  padding: 0.125rem 0.5rem;
  background: #e0e7ff;
  color: #667eea;
  border-radius: 9999px;
  font-weight: 500;
}

.view-matter-link {
  color: #667eea;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

/* Loading States */
.loading-skeleton {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.skeleton-item {
  background: linear-gradient(90deg, #f7fafc 25%, #e2e8f0 50%, #f7fafc 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 0.5rem;
}

.skeleton-line {
  height: 1rem;
  width: 100%;
}

.skeleton-card {
  height: 120px;
  border-radius: 0.75rem;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #718096;
}

.empty-state svg {
  width: 64px;
  height: 64px;
  margin: 0 auto 1rem;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.125rem;
  font-weight: 600;
  color: #4a5568;
  margin-bottom: 0.5rem;
}

.empty-state p {
  font-size: 0.875rem;
}

/* Status Message */
.status-message {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: #718096;
  margin-bottom: 1rem;
}

.status-icon {
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  #calendar-widget-container {
    margin: 1rem;
    border-radius: 1rem;
  }
  
  #calendar-widget {
    padding: 1.5rem;
  }
  
  .calendar-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-title h1 {
    font-size: 1.5rem;
  }
  
  .nav-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .calendar-nav {
    order: 2;
    justify-content: center;
  }
  
  .view-toggle {
    order: 1;
    justify-content: center;
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }
  
  .month-grid {
    font-size: 0.8125rem;
  }
  
  .calendar-day {
    min-height: 80px;
  }
  
  .weekday-header {
    font-size: 0.6875rem;
    padding: 0.5rem 0.25rem;
  }
}

@media (max-width: 640px) {
  #calendar-widget-container {
    margin: 0.5rem;
  }
  
  #calendar-widget {
    padding: 1rem;
  }
  
  .header-actions {
    width: 100%;
    justify-content: stretch;
  }
  
  .btn {
    flex: 1;
    justify-content: center;
  }
  
  .modal-content {
    margin: 1rem;
    max-height: calc(100vh - 2rem);
  }
}
</style>
</head>
<body>

<!-- Main Calendar Widget Container -->
<div id="calendar-widget-container">
  <div class="gradient-bar"></div>
  
  <!-- Calendar Widget -->
  <div id="calendar-widget">
    <!-- Header -->
    <div class="calendar-header">
      <div class="header-title">
        <div class="calendar-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="28" height="28">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <h1>Nashville Events Calendar</h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportEvents()">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Export
        </button>
        <button class="btn btn-primary" onclick="refreshEvents()">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>
    
    <!-- Navigation Controls -->
    <div class="nav-controls">
      <div class="calendar-nav">
        <button class="nav-btn" onclick="navigatePeriod('prev')">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="current-period" id="current-period">Loading...</div>
        <button class="nav-btn" onclick="navigatePeriod('next')">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
        <button class="nav-btn" onclick="navigateToToday()">
          Today
        </button>
      </div>
      
      <div class="view-toggle">
        <button class="view-btn active" data-view="month" onclick="switchView('month')">Month</button>
        <button class="view-btn" data-view="week" onclick="switchView('week')">Week</button>
        <button class="view-btn" data-view="list" onclick="switchView('list')">List</button>
      </div>
    </div>
    
    <!-- Filters Section -->
    <div class="filters-section" id="filters-section">
      <div class="filters-header">
        <div class="filters-title">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
          </svg>
          Filters
          <span class="filter-count" id="filter-count" style="display: none;">0</span>
        </div>
        <button class="btn btn-secondary" onclick="clearFilters()" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem;">
          Clear All
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Body</label>
          <select class="filter-select" id="body-filter" onchange="applyFilters()">
            <option value="">All Bodies</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Date Range <span style="font-weight: normal; color: #a0aec0;">(List view)</span></label>
          <select class="filter-select" id="date-filter" onchange="applyFilters()" title="Only applies to List view">
            <option value="all">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Event Type</label>
          <select class="filter-select" id="type-filter" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="regular">Regular Meeting</option>
            <option value="special">Special Meeting</option>
            <option value="workshop">Workshop</option>
            <option value="hearing">Public Hearing</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Search</label>
          <input type="text" class="filter-select" id="search-filter" placeholder="Search events..." onkeyup="applyFilters()">
        </div>
      </div>
    </div>
    
    <!-- Status Message -->
    <div class="status-message" id="status-message">
      <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      <span>Loading calendar events...</span>
    </div>
    
    <!-- Calendar Views Container -->
    <div id="calendar-content">
      <div class="loading-skeleton">
        <div class="skeleton-item skeleton-card"></div>
        <div class="skeleton-item skeleton-card"></div>
        <div class="skeleton-item skeleton-card"></div>
      </div>
    </div>
  </div>
</div>

<!-- Event Details Modal -->
<div class="modal" id="event-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-title">Event Details</h2>
      <button class="close-btn" onclick="closeModal()">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- Event details will be populated here -->
    </div>
  </div>
</div>

<script>
(function() {
  // Configuration
  const CONFIG = {
    softrDomain: 'https://eonashville.softr.app',
    debugMode: false,
    defaultView: 'month',
    itemsPerPage: 50,
    cacheExpiry: 5 * 60 * 1000 // 5 minutes
  };
  
  // API endpoints
  const baseUrl = 'https://webapi.legistar.com/v1/nashville';
  const corsProxy = 'https://corsproxy.io/?';
  
  // State
  let currentView = CONFIG.defaultView;
  let currentDate = new Date();
  let events = [];
  let filteredEvents = [];
  let bodies = [];
  let eventsCache = new Map(); // Cache events by date range
  let activeFilters = {
    body: '',
    dateRange: 'month',
    type: '',
    search: ''
  };
  
  // DOM elements
  const calendarContent = document.getElementById('calendar-content');
  const currentPeriodEl = document.getElementById('current-period');
  const statusMessage = document.getElementById('status-message');
  const filterCount = document.getElementById('filter-count');
  
  // Initialize
  function init() {
    if (CONFIG.debugMode) {
      console.log('Calendar Widget Initialized');
    }
    
    loadBodies();
    loadEventsForCurrentView();
    setupEventListeners();
  }
  
  // Setup event listeners
  function setupEventListeners() {
    // Close modal on outside click
    document.getElementById('event-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      } else if (e.key === 'ArrowLeft' && !e.target.matches('input')) {
        navigatePeriod('prev');
      } else if (e.key === 'ArrowRight' && !e.target.matches('input')) {
        navigatePeriod('next');
      }
    });
  }
  
  // Generate cache key for date range
  function getCacheKey(start, end) {
    return `${start.toISOString()}_${end.toISOString()}`;
  }
  
  // Check if cache is valid
  function isCacheValid(cacheEntry) {
    return cacheEntry && (Date.now() - cacheEntry.timestamp < CONFIG.cacheExpiry);
  }
  
  // Load bodies for filter
  async function loadBodies() {
    try {
      const response = await fetch(corsProxy + encodeURIComponent(`${baseUrl}/bodies`));
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      bodies = data || [];
      
      // Populate body filter
      const bodyFilter = document.getElementById('body-filter');
      bodyFilter.innerHTML = '<option value="">All Bodies</option>';
      
      bodies.forEach(body => {
        const option = document.createElement('option');
        option.value = body.BodyId;
        option.textContent = body.BodyName;
        bodyFilter.appendChild(option);
      });
    } catch (err) {
      console.error('Error loading bodies:', err);
    }
  }
  
  // Load events for the current view
  function loadEventsForCurrentView() {
    if (currentView === 'list') {
      // List view uses filter date range
      loadEvents();
    } else {
      // Month/Week views load for specific period
      loadEvents(currentDate);
    }
  }
  
  // Load events
  async function loadEvents(specificDate = null) {
    try {
      showStatus('Loading calendar events...');
      
      // Calculate date range
      let dateRange;
      if (specificDate && (currentView === 'month' || currentView === 'week')) {
        dateRange = getViewDateRange(specificDate);
      } else {
        dateRange = getDateRange();
      }
      
      // Check cache
      const cacheKey = getCacheKey(dateRange.start, dateRange.end);
      const cachedEntry = eventsCache.get(cacheKey);
      
      if (isCacheValid(cachedEntry)) {
        events = cachedEntry.data;
        applyFilters();
        hideStatus();
        return;
      }
      
      // Build API URL
      let url = `${baseUrl}/events?$orderby=EventDate desc`;
      
      if (dateRange.start && dateRange.end) {
        const startStr = dateRange.start.toISOString().split('T')[0];
        const endStr = dateRange.end.toISOString().split('T')[0];
        url += `&$filter=EventDate ge datetime'${startStr}' and EventDate le datetime'${endStr}'`;
      }
      
      if (CONFIG.debugMode) {
        console.log('Loading events for range:', startStr, 'to', endStr);
      }
      
      const response = await fetch(corsProxy + encodeURIComponent(url));
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      events = data || [];
      
      // Cache the results
      eventsCache.set(cacheKey, {
        data: events,
        timestamp: Date.now()
      });
      
      // Load event items for each event
      await loadEventItems();
      
      applyFilters();
      hideStatus();
      
    } catch (err) {
      console.error('Error loading events:', err);
      showError('Failed to load calendar events');
    }
  }
  
  // Get date range for the current view (month/week)
  function getViewDateRange(date) {
    const start = new Date(date);
    const end = new Date(date);
    
    if (currentView === 'month') {
      // Get the full month being viewed
      start.setDate(1);
      start.setHours(0, 0, 0, 0);
      end.setMonth(date.getMonth() + 1, 0);
      end.setHours(23, 59, 59, 999);
      
      // Extend to include days from prev/next month shown in calendar
      start.setDate(start.getDate() - start.getDay()); // Start from Sunday
      end.setDate(end.getDate() + (6 - end.getDay())); // End on Saturday
    } else if (currentView === 'week') {
      // Get the week being viewed
      start.setDate(date.getDate() - date.getDay());
      start.setHours(0, 0, 0, 0);
      end.setDate(start.getDate() + 6);
      end.setHours(23, 59, 59, 999);
    }
    
    return { start, end };
  }
  
  // Load event items
  async function loadEventItems() {
    const loadPromises = events.slice(0, 20).map(async (event) => {
      try {
        const url = `${baseUrl}/events/${event.EventId}/eventitems?AgendaNote=1&MinutesNote=1`;
        const response = await fetch(corsProxy + encodeURIComponent(url));
        if (response.ok) {
          event.EventItems = await response.json();
          
          // Check which items have matters
          event.EventItems.forEach(item => {
            item.hasMatter = !!(item.EventItemMatterId || item.EventItemMatterFile);
          });
          
          // Count items with matters
          event.mattersCount = event.EventItems.filter(item => item.hasMatter).length;
        }
      } catch (err) {
        console.error(`Error loading items for event ${event.EventId}:`, err);
      }
    });
    
    await Promise.all(loadPromises);
  }
  
  // Get date range based on filter
  function getDateRange() {
    const now = new Date();
    const start = new Date(now);
    const end = new Date(now);
    
    switch (activeFilters.dateRange) {
      case 'today':
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
        break;
      case 'week':
        start.setDate(now.getDate() - now.getDay());
        start.setHours(0, 0, 0, 0);
        end.setDate(start.getDate() + 6);
        end.setHours(23, 59, 59, 999);
        break;
      case 'month':
        start.setDate(1);
        start.setHours(0, 0, 0, 0);
        end.setMonth(now.getMonth() + 1, 0);
        end.setHours(23, 59, 59, 999);
        break;
      case 'quarter':
        const quarter = Math.floor(now.getMonth() / 3);
        start.setMonth(quarter * 3, 1);
        start.setHours(0, 0, 0, 0);
        end.setMonth(quarter * 3 + 3, 0);
        end.setHours(23, 59, 59, 999);
        break;
      case 'year':
        start.setMonth(0, 1);
        start.setHours(0, 0, 0, 0);
        end.setMonth(11, 31);
        end.setHours(23, 59, 59, 999);
        break;
      case 'all':
        // Load past year to next year
        start.setFullYear(now.getFullYear() - 1);
        start.setMonth(0, 1);
        start.setHours(0, 0, 0, 0);
        end.setFullYear(now.getFullYear() + 1);
        end.setMonth(11, 31);
        end.setHours(23, 59, 59, 999);
        break;
      default:
        return { start: null, end: null };
    }
    
    return { start, end };
  }
  
  // Apply filters
  window.applyFilters = function() {
    const previousDateRange = activeFilters.dateRange;
    
    activeFilters = {
      body: document.getElementById('body-filter').value,
      dateRange: document.getElementById('date-filter').value,
      type: document.getElementById('type-filter').value,
      search: document.getElementById('search-filter').value.toLowerCase()
    };
    
    // If date range filter changed and we're in list view, reload events
    if (previousDateRange !== activeFilters.dateRange && currentView === 'list') {
      loadEvents();
      return; // loadEvents will call applyFilters again
    }
    
    filteredEvents = events.filter(event => {
      // Body filter
      if (activeFilters.body && event.EventBodyId != activeFilters.body) {
        return false;
      }
      
      // Search filter
      if (activeFilters.search) {
        const searchString = `${event.EventBodyName} ${event.EventLocation} ${event.EventComment || ''}`.toLowerCase();
        if (!searchString.includes(activeFilters.search)) {
          return false;
        }
      }
      
      return true;
    });
    
    // Update filter count
    const activeCount = Object.values(activeFilters).filter(v => v && v !== 'month').length;
    if (activeCount > 0) {
      filterCount.textContent = activeCount;
      filterCount.style.display = 'inline-flex';
    } else {
      filterCount.style.display = 'none';
    }
    
    renderView();
  }
  
  // Clear filters
  window.clearFilters = function() {
    document.getElementById('body-filter').value = '';
    document.getElementById('date-filter').value = 'month';
    document.getElementById('type-filter').value = '';
    document.getElementById('search-filter').value = '';
    applyFilters();
  }
  
  // Switch view
  window.switchView = function(view) {
    const previousView = currentView;
    currentView = view;
    
    // Update view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === view);
    });
    
    // Load appropriate events for the new view
    loadEventsForCurrentView();
  }
  
  // Navigate period
  window.navigatePeriod = function(direction) {
    switch (currentView) {
      case 'month':
        currentDate.setMonth(currentDate.getMonth() + (direction === 'next' ? 1 : -1));
        loadEvents(currentDate);
        break;
      case 'week':
        currentDate.setDate(currentDate.getDate() + (direction === 'next' ? 7 : -7));
        loadEvents(currentDate);
        break;
      case 'list':
        // List view doesn't navigate
        return;
    }
  }
  
  // Navigate to today
  window.navigateToToday = function() {
    currentDate = new Date();
    loadEventsForCurrentView();
  }
  
  // Render current view
  function renderView() {
    switch (currentView) {
      case 'month':
        renderMonthView();
        break;
      case 'week':
        renderWeekView();
        break;
      case 'list':
        renderListView();
        break;
    }
    
    updatePeriodDisplay();
  }
  
  // Update period display
  function updatePeriodDisplay() {
    const options = { year: 'numeric', month: 'long' };
    
    switch (currentView) {
      case 'month':
        currentPeriodEl.textContent = currentDate.toLocaleDateString('en-US', options);
        break;
      case 'week':
        const weekStart = new Date(currentDate);
        weekStart.setDate(currentDate.getDate() - currentDate.getDay());
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const format = { month: 'short', day: 'numeric' };
        currentPeriodEl.textContent = `${weekStart.toLocaleDateString('en-US', format)} - ${weekEnd.toLocaleDateString('en-US', format)}, ${weekEnd.getFullYear()}`;
        break;
      case 'list':
        const filterText = document.querySelector('#date-filter option:checked').text;
        currentPeriodEl.textContent = `${filteredEvents.length} Events (${filterText})`;
        break;
    }
  }
  
  // Render month view
  function renderMonthView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let html = '<div class="calendar-view active" id="month-view"><div class="month-grid">';
    
    // Weekday headers
    const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    weekdays.forEach(day => {
      html += `<div class="weekday-header">${day}</div>`;
    });
    
    // Calendar days
    const currentDateCopy = new Date(startDate);
    for (let i = 0; i < 42; i++) {
      const isCurrentMonth = currentDateCopy.getMonth() === month;
      const isToday = currentDateCopy.getTime() === today.getTime();
      const dayEvents = getEventsForDate(currentDateCopy);
      
      html += `<div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" data-date="${currentDateCopy.toISOString()}">`;
      html += `<div class="day-number">${currentDateCopy.getDate()}</div>`;
      
      if (dayEvents.length > 0) {
        html += '<div class="day-events">';
        dayEvents.slice(0, 3).forEach(event => {
          const bodyClass = getBodyClass(event.EventBodyName);
          const hasLegislation = event.mattersCount > 0;
          html += `<div class="event-dot ${bodyClass}" onclick="showEventDetails(${event.EventId})" title="${event.EventBodyName}${hasLegislation ? ' - Has legislation' : ''}">${event.EventBodyName}${hasLegislation ? ' ðŸ“‹' : ''}</div>`;
        });
        
        if (dayEvents.length > 3) {
          html += `<div class="more-events">+${dayEvents.length - 3} more</div>`;
        }
        html += '</div>';
      }
      
      html += '</div>';
      currentDateCopy.setDate(currentDateCopy.getDate() + 1);
    }
    
    html += '</div></div>';
    calendarContent.innerHTML = html;
  }
  
  // Render week view
  function renderWeekView() {
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - currentDate.getDay());
    weekStart.setHours(0, 0, 0, 0);
    
    let html = '<div class="calendar-view active" id="week-view">';
    
    // Create time slots grid
    html += '<div class="week-grid">';
    
    // Header row
    html += '<div class="time-slot"></div>'; // Empty corner
    
    const dayHeaders = [];
    for (let i = 0; i < 7; i++) {
      const date = new Date(weekStart);
      date.setDate(weekStart.getDate() + i);
      const isToday = date.toDateString() === new Date().toDateString();
      
      dayHeaders.push(date);
      html += `<div class="weekday-header" style="background: ${isToday ? '#f0f4ff' : '#f8fafc'}">
        <div style="font-weight: 600;">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
        <div style="font-size: 0.875rem;">${date.getDate()}</div>
      </div>`;
    }
    
    // Time slots
    for (let hour = 0; hour < 24; hour++) {
      html += `<div class="time-slot">${hour === 0 ? '12 AM' : hour < 12 ? `${hour} AM` : hour === 12 ? '12 PM' : `${hour - 12} PM`}</div>`;
      
      // Day columns for this hour
      for (let day = 0; day < 7; day++) {
        html += `<div class="week-day-column" data-hour="${hour}" data-day="${day}"></div>`;
      }
    }
    
    html += '</div>';
    
    // Add events to the grid
    dayHeaders.forEach((date, dayIndex) => {
      const dayEvents = getEventsForDate(date);
      dayEvents.forEach(event => {
        const eventDate = new Date(event.EventDate);
        const hour = eventDate.getHours();
        const minutes = eventDate.getMinutes();
        const top = (hour * 60 + minutes) * (60 / 60); // 60px per hour
        const duration = event.EventDuration || 60; // Default 1 hour
        const height = Math.max(20, (duration / 60) * 60);
        const hasLegislation = event.mattersCount > 0;
        
        // Find the cell
        const cell = document.querySelector(`[data-hour="${hour}"][data-day="${dayIndex}"]`);
        if (cell) {
          const eventEl = document.createElement('div');
          eventEl.className = 'week-event';
          eventEl.style.top = `${minutes}px`;
          eventEl.style.height = `${height}px`;
          eventEl.onclick = () => showEventDetails(event.EventId);
          eventEl.innerHTML = `
            <div style="font-weight: 600; font-size: 0.7rem;">${formatTime(eventDate)} ${hasLegislation ? 'ðŸ“‹' : ''}</div>
            <div style="font-size: 0.7rem;">${event.EventBodyName}</div>
          `;
          cell.appendChild(eventEl);
        }
      });
    });
    
    html += '</div>';
    calendarContent.innerHTML = html;
  }
  
  // Render list view
  function renderListView() {
    if (filteredEvents.length === 0) {
      calendarContent.innerHTML = `
        <div class="calendar-view active">
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <h3>No Events Found</h3>
            <p>Try adjusting your filters or date range</p>
          </div>
        </div>
      `;
      return;
    }
    
    // Sort events by date
    const sortedEvents = [...filteredEvents].sort((a, b) => 
      new Date(a.EventDate) - new Date(b.EventDate)
    );
    
    let html = '<div class="calendar-view active" id="list-view"><div class="events-list">';
    
    let currentMonth = null;
    sortedEvents.forEach(event => {
      const eventDate = new Date(event.EventDate);
      const monthYear = eventDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      
      // Add month header
      if (monthYear !== currentMonth) {
        currentMonth = monthYear;
        html += `<h3 style="margin: 1.5rem 0 1rem; font-size: 1.125rem; font-weight: 600; color: #2d3748;">${monthYear}</h3>`;
      }
      
      html += `
        <div class="event-card" onclick="showEventDetails(${event.EventId})">
          <div class="event-header">
            <div class="event-time">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span>${formatDate(eventDate)} at ${formatTime(eventDate)}</span>
            </div>
            <div class="event-body-badge">${event.EventBodyName}</div>
          </div>
          <div class="event-details">
            <div class="event-title">${event.EventBodyName} Meeting</div>
            ${event.EventLocation ? `
              <div class="event-location">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span>${event.EventLocation}</span>
              </div>
            ` : ''}
            <div style="display: flex; gap: 0.5rem;">
              ${event.EventItems && event.EventItems.length > 0 ? `
                <div class="event-items-count">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                  ${event.EventItems.length} Agenda Items
                </div>
              ` : ''}
              ${event.mattersCount > 0 ? `
                <div class="legislation-count">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  ${event.mattersCount} Legislation
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
    calendarContent.innerHTML = html;
  }
  
  // Get events for a specific date
  function getEventsForDate(date) {
    const dateStr = date.toISOString().split('T')[0];
    return filteredEvents.filter(event => {
      const eventDate = new Date(event.EventDate);
      return eventDate.toISOString().split('T')[0] === dateStr;
    });
  }
  
  // Get body class for styling
  function getBodyClass(bodyName) {
    const name = bodyName.toLowerCase();
    if (name.includes('council')) return 'body-council';
    if (name.includes('committee')) return 'body-committee';
    if (name.includes('board')) return 'body-board';
    return 'body-council';
  }
  
  // Open matter in Softr app
  window.openMatter = function(matterId, matterFile) {
    if (!matterId) return;
    
    // Open in your Softr app
    const url = `${CONFIG.softrDomain}/legislation-details?recordId=${matterId}`;
    window.open(url, '_blank');
  }
  
  // Show event details
  window.showEventDetails = async function(eventId) {
    const event = events.find(e => e.EventId === eventId);
    if (!event) return;
    
    const modal = document.getElementById('event-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    
    modalTitle.textContent = event.EventBodyName + ' Meeting';
    
    // Load full event details if needed
    if (!event.EventItems) {
      try {
        const url = `${baseUrl}/events/${eventId}/eventitems?AgendaNote=1&MinutesNote=1`;
        const response = await fetch(corsProxy + encodeURIComponent(url));
        if (response.ok) {
          event.EventItems = await response.json();
          
          // Check which items have matters
          event.EventItems.forEach(item => {
            item.hasMatter = !!(item.EventItemMatterId || item.EventItemMatterFile);
          });
          
          // Count items with matters
          event.mattersCount = event.EventItems.filter(item => item.hasMatter).length;
        }
      } catch (err) {
        console.error('Error loading event items:', err);
      }
    }
    
    const eventDate = new Date(event.EventDate);
    
    let detailsHTML = `
      <div class="event-detail-section">
        <div class="detail-label">Date & Time</div>
        <div class="detail-value">${formatDate(eventDate)} at ${formatTime(eventDate)}</div>
      </div>
      
      ${event.EventLocation ? `
        <div class="event-detail-section">
          <div class="detail-label">Location</div>
          <div class="detail-value">${event.EventLocation}</div>
        </div>
      ` : ''}
      
      ${event.EventComment ? `
        <div class="event-detail-section">
          <div class="detail-label">Notes</div>
          <div class="detail-value">${event.EventComment}</div>
        </div>
      ` : ''}
      
      ${event.EventVideoPath ? `
        <div class="event-detail-section">
          <div class="detail-label">Video</div>
          <div class="detail-value">
            <a href="${event.EventVideoPath}" target="_blank" style="color: #667eea; text-decoration: none;">
              Watch Meeting Video â†’
            </a>
          </div>
        </div>
      ` : ''}
    `;
    
    if (event.EventItems && event.EventItems.length > 0) {
      const itemsWithMatters = event.EventItems.filter(item => item.hasMatter);
      
      detailsHTML += `
        <div class="event-detail-section">
          <div class="detail-label">
            Agenda Items (${event.EventItems.length})
            ${itemsWithMatters.length > 0 ? `<span style="color: #667eea; font-weight: normal;"> - ${itemsWithMatters.length} with legislation</span>` : ''}
          </div>
          <div class="agenda-items-list">
      `;
      
      event.EventItems.forEach(item => {
        const hasMatter = item.hasMatter;
        
        detailsHTML += `
          <div class="agenda-item ${hasMatter ? 'has-matter' : ''}" 
               ${hasMatter ? `onclick="event.stopPropagation(); openMatter(${item.EventItemMatterId}, '${item.EventItemMatterFile}')"` : ''}>
            <div class="agenda-item-header">
              <div class="agenda-item-number">
                ${item.EventItemAgendaNumber || 'Item'}
              </div>
              ${hasMatter ? '<div class="matter-indicator">ðŸ“‹ Has Legislation</div>' : ''}
            </div>
            <div class="agenda-item-title">${item.EventItemTitle || item.EventItemName || 'No title'}</div>
            ${hasMatter ? `
              <div class="matter-info">
                ${item.EventItemMatterFile ? `<span class="matter-file">File: ${item.EventItemMatterFile}</span>` : ''}
                ${item.EventItemMatterType ? `<span class="matter-type">${item.EventItemMatterType}</span>` : ''}
                <span class="view-matter-link">View Details â†’</span>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      detailsHTML += '</div></div>';
    }
    
    modalBody.innerHTML = detailsHTML;
    modal.classList.add('active');
  }
  
  // Close modal
  window.closeModal = function() {
    document.getElementById('event-modal').classList.remove('active');
  }
  
  // Export events
  window.exportEvents = function() {
    if (filteredEvents.length === 0) {
      alert('No events to export');
      return;
    }
    
    // CSV Headers
    const headers = ['Date', 'Time', 'Body', 'Location', 'Agenda Items Count', 'Legislation Count'];
    
    // Convert to CSV
    const rows = filteredEvents.map(event => {
      const date = new Date(event.EventDate);
      return [
        formatDate(date),
        formatTime(date),
        event.EventBodyName,
        event.EventLocation || '',
        event.EventItems ? event.EventItems.length : 0,
        event.mattersCount || 0
      ].map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });
    
    const csv = [headers.join(','), ...rows].join('\n');
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `nashville_events_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  // Refresh events
  window.refreshEvents = function() {
    // Clear cache to force fresh load
    eventsCache.clear();
    loadEventsForCurrentView();
  }
  
  // Utility functions
  function formatDate(date) {
    return date.toLocaleDateString('en-US', { 
      weekday: 'short',
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  }
  
  function formatTime(date) {
    return date.toLocaleTimeString('en-US', { 
      hour: 'numeric',
      minute: '2-digit',
      hour12: true 
    });
  }
  
  function showStatus(message) {
    statusMessage.style.display = 'flex';
    statusMessage.querySelector('span').textContent = message;
  }
  
  function hideStatus() {
    statusMessage.style.display = 'none';
  }
  
  function showError(message) {
    calendarContent.innerHTML = `
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3>Error Loading Calendar</h3>
        <p>${message}</p>
        <button class="btn btn-primary" onclick="refreshEvents()" style="margin-top: 1rem;">
          Try Again
        </button>
      </div>
    `;
    hideStatus();
  }
  
  // Initialize the calendar
  init();
})();
</script>

</body>
</html>